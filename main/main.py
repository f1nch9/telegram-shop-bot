import threading
import time

# –ò–º–ø–æ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ —É—Ç–∏–ª–∏—Ç
from loader import bot
from database.database import init_db
from utils.utils import periodic_cache_update, periodic_backup_task, update_catalog_cache

# –í–ê–ñ–ù–û: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ö—ç–Ω–¥–ª–µ—Ä—ã, —á—Ç–æ–±—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã —Å—Ä–∞–±–æ—Ç–∞–ª–∏ –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ –∫–æ–º–∞–Ω–¥—ã
# (–ï—Å–ª–∏ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏ —É–¥–∞–ª–∏—Ç—å, –±–æ—Ç –Ω–µ –±—É–¥–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è)
import handlers.handlers_admin
import handlers.handlers_user

if __name__ == "__main__":
    print("--- üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –±–æ—Ç–∞ ---")

    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –º–∏–≥—Ä–∞—Ü–∏—è –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö
    try:
        init_db()
        print("--- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ ---")
    except Exception as e:
        print(f"--- ‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")
        exit(1)

    # 2. –ü–µ—Ä–≤–∏—á–Ω–æ–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫—ç—à–∞
    # (–î–µ–ª–∞–µ–º —ç—Ç–æ –¥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∂–¥–∞–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏)
    print("--- ‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –∫–∞—Ç–∞–ª–æ–≥ –∏–∑ Google –¢–∞–±–ª–∏—Ü... ---")
    if update_catalog_cache():
        print("--- ‚úÖ –ö—ç—à –∫–∞—Ç–∞–ª–æ–≥–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω ---")
    else:
        print("--- ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Google. ---")

    # 3. –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á (Threads)
    # daemon=True –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ –∑–∞–∫—Ä–æ—é—Ç—Å—è —Å–∞–º–∏, –∫–æ–≥–¥–∞ –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
    
    # –ü–æ—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ (—Ä–∞–∑ –≤ 10 –º–∏–Ω)
    cache_thread = threading.Thread(target=periodic_cache_update, daemon=True)
    cache_thread.start()
    
    # –ü–æ—Ç–æ–∫ –±—ç–∫–∞–ø–æ–≤ (—Ä–∞–∑ –≤ 4 —á–∞—Å–∞)
    backup_thread = threading.Thread(target=periodic_backup_task, daemon=True)
    backup_thread.start()
    
    print("--- ‚úÖ –§–æ–Ω–æ–≤—ã–µ —Å–ª—É–∂–±—ã (–∫—ç—à, –±—ç–∫–∞–ø—ã) –∑–∞–ø—É—â–µ–Ω—ã ---")

    # 4. –ó–∞–ø—É—Å–∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    print("--- ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π! –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏. ---")
    try:
        # infinity_polling –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –º–µ–ª–∫–∏—Ö —Å–±–æ—è—Ö —Å–µ—Ç–∏
        bot.infinity_polling(timeout=10, long_polling_timeout=5)
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞: {e}")
        time.sleep(5)
    except KeyboardInterrupt:
        print("\n--- üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ---")